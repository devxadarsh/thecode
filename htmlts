// view-payment-mode.component.ts
import { Component, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ActivatedRoute, Router } from '@angular/router';
import { PaymentConfigService } from '../payment-mode/payment-config.service';
import { ReactiveFormsModule } from '@angular/forms';

interface ConfigField {
  id: string;
  label: string;
  type: 'checkbox' | 'radio' | 'select' | 'text' | 'info';
  options?: FieldOption[];
  displayType?: 'grid' | 'list';
  gridColumns?: number;
  required?: boolean;
  infoText?: string;
}

interface FieldOption {
  value: string;
  label: string;
  isFrequent?: boolean;
}

interface PaymentModeConfig {
  paymentMode: string;
  sections: ConfigSection[];
}

interface ConfigSection {
  id: string;
  title: string;
  fields: ConfigField[];
}

interface SavedConfiguration {
  configurationId: string;
  merchantId: string;
  merchantName?: string;
  paymentMode: string;
  config: any;
  createdAt?: string;
  updatedAt?: string;
}

@Component({
  selector: 'app-edit-payment-mode',
  standalone: true,
  imports: [ReactiveFormsModule, CommonModule],
  templateUrl: './edit-payment-mode.component.html',
  styleUrls: ['./edit-payment-mode.component.scss']
})
export class EditPaymentModeComponent implements OnInit {
  savedConfiguration: SavedConfiguration | null = null;
  paymentModeConfig: PaymentModeConfig | null = null;
  isLoading: boolean = true;
  errorMessage: string | null = null;

  constructor(
    private route: ActivatedRoute,
    private router: Router,
    private paymentConfigService: PaymentConfigService
  ) { }

  ngOnInit(): void {
    // Get merchantId and paymentMode from route params
    this.route.params.subscribe(params => {
      const merchantId = params['merchantId'];
      const paymentMode = params['paymentMode'];

      if (merchantId && paymentMode) {
        this.loadConfiguration(merchantId, paymentMode);
      } else {
        this.errorMessage = 'Invalid route parameters';
        this.isLoading = false;
      }
    });

    // Alternative: Get from query params
    // this.route.queryParams.subscribe(params => {
    //   const merchantId = params['merchantId'];
    //   const paymentMode = params['paymentMode'];
    //   if (merchantId && paymentMode) {
    //     this.loadConfiguration(merchantId, paymentMode);
    //   }
    // });
  }

  loadConfiguration(merchantId: string, paymentMode: string): void {
    this.isLoading = true;

    // First load the payment mode config structure
    this.paymentConfigService.getPaymentModeConfig(paymentMode).subscribe({
      next: (config) => {
        this.paymentModeConfig = config;

        // Then load the saved configuration
        this.loadSavedConfiguration(merchantId, paymentMode);
      },
      error: (error) => {
        console.error('Error loading payment mode config:', error);
        this.errorMessage = 'Error loading payment mode configuration';
        this.isLoading = false;
      }
    });
  }

  loadSavedConfiguration(merchantId: string, paymentMode: string): void {
    this.paymentConfigService.getSavedConfiguration(merchantId, paymentMode).subscribe({
      next: (savedConfig) => {
        this.savedConfiguration = savedConfig;
        this.isLoading = false;
      },
      error: (error) => {
        console.error('Error loading saved configuration:', error);
        this.errorMessage = 'No configuration found for this merchant and payment mode';
        this.isLoading = false;
      }
    });
  }

  // Get field configuration by ID
  getFieldConfig(fieldId: string): ConfigField | null {
    if (!this.paymentModeConfig) return null;

    for (const section of this.paymentModeConfig.sections) {
      const field = section.fields.find(f => f.id === fieldId);
      if (field) return field;
    }
    return null;
  }

  // Get selected values as readable text
  getFieldDisplayValue(fieldId: string): string {
    if (!this.savedConfiguration?.config) return 'Not configured';

    const value = this.savedConfiguration.config[fieldId];
    const fieldConfig = this.getFieldConfig(fieldId);

    if (!value) return 'Not selected';
    if (!fieldConfig) return value;

    // Handle different field types
    if (fieldConfig.type === 'checkbox' && Array.isArray(value)) {
      if (value.length === 0) return 'Not selected';

      const labels = value.map(v => {
        const option = fieldConfig.options?.find(opt => opt.value === v);
        return option ? option.label : v;
      });
      return labels.join(', ');
    }

    if (fieldConfig.type === 'radio' || fieldConfig.type === 'select') {
      const option = fieldConfig.options?.find(opt => opt.value === value);
      return option ? option.label : value;
    }

    if (fieldConfig.type === 'text') {
      return value || 'Not provided';
    }

    return value;
  }

  // Check if field has value
  hasFieldValue(fieldId: string): boolean {
    if (!this.savedConfiguration?.config) return false;
    const value = this.savedConfiguration.config[fieldId];

    if (Array.isArray(value)) {
      return value.length > 0;
    }

    return !!value;
  }

  // Navigate to edit page
  onEdit(): void {
    if (this.savedConfiguration) {
      this.router.navigate(['/edit-payment-mode'], {
        queryParams: {
          merchantId: this.savedConfiguration.merchantId,
          paymentMode: this.savedConfiguration.paymentMode
        }
      });
    }
  }

  // Go back
  onBack(): void {
    this.router.navigate(['/payment-modes']);
  }

  // Format date
  formatDate(dateString?: string): string {
    if (!dateString) return 'N/A';
    const date = new Date(dateString);
    return date.toLocaleString('en-IN', {
      year: 'numeric',
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
}
